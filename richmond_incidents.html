<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Richmond, VA - Live Incident Map (PREVIEW)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f4f4;
        }

        /* Make the map fill the available space */
        #map {
            flex-grow: 1;
            border-bottom: 1px solid #ccc;
        }

        header {
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }

        #status {
            font-size: 0.9rem;
            color: #555;
            background-color: #eee;
            padding: 5px 10px;
            border-radius: 12px;
        }

        /* Custom Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .leaflet-popup-content b {
            color: #1a1a1a;
        }
    </style>
</head>

<body>

    <header>
        <h1>Richmond, VA - Live Incident Map (PREVIEW)</h1>
        <div id="status">Loading...</div>
    </header>

    <!-- The map container -->
    <div id="map"></div>

    <script>
        // --- Map Initialization ---
        // Centered on Richmond, VA (approximate centroid)
        const map = L.map('map').setView([37.54, -77.43], 12);
        const incidentLayer = L.layerGroup().addTo(map);

        // Add the OpenStreetMap tile layer (the map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 50,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --- Data Fetching and Map Update ---
        const REFRESH_INTERVAL = 1800000; // 1,800,000 ms = 30 minutes
        const statusEl = document.getElementById('status');

        /**
         * Fetches incident data from the local JSON file.
         */
        async function fetchIncidents() {
            statusEl.textContent = 'Updating incidents...';
            try {
                // Fetch the JSON file generated by the Python script.
                // { cache: "no-store" } ensures we get a fresh file on every refresh.
                const response = await fetch('incidents.json', { cache: "no-store" });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Make sure 'incidents.json' file exists.`);
                }

                const incidents = await response.json();
                updateMap(incidents);
                statusEl.textContent = `Update Check: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error fetching incident data:', error);
                statusEl.textContent = 'Error loading data. See console.';
                // Don't clear markers if the fetch fails, just show the error
            }
        }

        /**
         * Clears old markers and adds new ones to the map.
         * @param {Array} incidents - An array of incident objects.
         */
        function updateMap(incidents) {
            // Clear all existing markers from the layer
            incidentLayer.clearLayers();

            if (!incidents || incidents.length === 0) {
                console.log("No active incidents to display.");
                return;
            }

            let validIncidents = 0;

            // Loop through each incident and add a marker
            incidents.forEach(incident => {
                // IMPORTANT: Only plot incidents that were successfully geocoded
                if (incident.lat && incident.lng) {
                    validIncidents++;
                    const lat = incident.lat;
                    const lng = incident.lng;

                    // Create the popup content
                    const popupContent = `
                        <b>${incident.type_specific}</b> (${incident.type_general})<br>
                        <b>Location:</b> ${incident.street || 'N/A'}<br>
                        <b>Intersection:</b> ${incident.nearest_intersection || 'N/A'}<br>
                        <b>Township:</b> ${incident.location_township}<br>
                        <b>Dispatched:</b> ${incident.dispatch_time}<br>
                        <b>Status:</b> ${incident.status || 'N/A'}
                    `;

                    // Create a circle marker
                    const marker = L.circleMarker([lat, lng], {
                        radius: 8,
                        color: '#d9534f', // A red color
                        fillColor: '#d9534f',
                        fillOpacity: 0.7
                    }).bindPopup(popupContent);

                    // Add the marker to our layer
                    incidentLayer.addLayer(marker);
                }
            });

            console.log(`Displayed ${validIncidents} out of ${incidents.length} incidents.`);
        }

        // --- Initial Load and Timer ---

        // Fetch data immediately on page load
        fetchIncidents();

        // Set an interval to fetch data every 4 minutes, just like the source page
        setInterval(fetchIncidents, REFRESH_INTERVAL);

    </script>
</body>

</html>